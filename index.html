<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>REYDEASES</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="./styles.css" />

    <!-- Performance: adelanta conexi√≥n con el Pixel -->
    <link rel="preconnect" href="https://connect.facebook.net" crossorigin />
    <link rel="dns-prefetch" href="//connect.facebook.net" />
    <link rel="preload" as="image" href="imagenes/fondo.png" />

    <!-- Meta Pixel Code (con coincidencias avanzadas manuales) -->
    <script>
      // Utilidades
      function getQS(name){ const u=new URLSearchParams(location.search); return u.get(name)||null }
      function normEmail(v){ return (v||"").trim().toLowerCase() }
      function normPhone(v){
        let p=(v||"").replace(/\D+/g,"");
        if(p && p.length===10) p="54"+p; // opcional, ajust√° a tu necesidad
        return p;
      }
      function getOrCreateExternalId(){
        const k="external_id";
        let id=localStorage.getItem(k);
        if(!id){
          id=(crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now()+"-"+Math.random().toString(16).slice(2));
          localStorage.setItem(k,id);
        }
        return id;
      }

      // Datos de usuario disponibles (querystring o localStorage)
      const userEmail  = normEmail( getQS("em") || localStorage.getItem("em") || "" );
      const userPhone  = normPhone( getQS("ph") || localStorage.getItem("ph") || "" );
      const externalId = getOrCreateExternalId();

      !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
      n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');

      // Coincidencias avanzadas
      fbq('init', 'TU_PIXEL_ID', {
        external_id: externalId,
        em: userEmail || undefined,
        ph: userPhone || undefined,
        country: 'AR'
      });

      fbq('track', 'PageView');
    </script>
    <noscript>
      <img height="1" width="1" style="display:none"
           src="https://www.facebook.com/tr?id=TU_PIXEL_ID&ev=PageView&noscript=1"/>
    </noscript>
    <!-- End Meta Pixel Code -->
  </head>

  <body>
    <div class="container background-image">
      <div class="overlay"></div>
      <div class="content">
        <!-- Logo PNG -->
        <img src="imagenes/logo.png" class="logo" width="240" height="120"
             alt="CloverBlack" decoding="async" fetchpriority="high" />

        <p class="title">Envianos un WhatsApp<br />para crear tu cuenta</p>

        <a class="whatsapp-button" id="whatsappButton">
          <span>¬°Contact√° ya!</span>
          <img src="imagenes/whatsapp.png" alt="whatsapp"
               class="whatsapp-icon" width="24" height="24" decoding="async" loading="lazy" />
        </a>

        <p class="subtitle">M√≠nimo de carga 2.000<br />S√≠n Cronogramas<br />Gan√°s y cobr√°s a cualquier hora</p>
        <p class="description">RED OFICIAL: REY DE ASES</p>
      </div>
    </div>

    <!-- Script WhatsApp con n√∫mero din√°mico desde backend -->
    <script>
      // === Configur√° tu prefijo ac√° ===
      const LANDING_PREFIX = ""; // Cambi√° si quer√©s otro prefijo

      // Lee un par√°metro de la URL (?utm_campaign=...)
      function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        const v = params.get(name);
        return v ? decodeURIComponent(v) : null;
      }

      // Normaliza la UTM para el c√≥digo (sin espacios/s√≠mbolos raros)
      function normalizeUtm(v) {
        return String(v || "")
          .trim()
          .replace(/\s+/g, "_")
          .replace(/[^A-Za-z0-9_-]/g, "")
          || "ORG";
      }

      // Persistimos utm_campaign si viene en la URL
      (function persistUTM() {
        const utmFromUrl = getQueryParam("utm_campaign");
        if (utmFromUrl) {
          localStorage.setItem("utm_campaign", utmFromUrl);
        }
      })();

      // Obtiene utm_campaign (URL > localStorage > "ORG")
      function getUTMCampaign() {
        return getQueryParam("utm_campaign") || localStorage.getItem("utm_campaign") || "ORG";
      }

      // üîÅ Obtiene un n√∫mero din√°mico desde /api/get-random-phone
      async function obtenerNumeroWhatsApp() {
        try {
          const res = await fetch("/api/get-random-phone", {
            headers: { "Cache-Control": "no-store" }
          });

          if (!res.ok) throw new Error("HTTP " + res.status);

          const data = await res.json();
          const raw = (data && data.number) ? String(data.number).trim() : null;
          if (!raw) throw new Error("N√∫mero vac√≠o");

          // Quitamos '+' por las dudas
          return raw.replace("+", "");
        } catch (err) {
          console.error("‚ùå Error obteniendo n√∫mero din√°mico, usando fallback:", err);

          // Fallback ultra b√°sico (ya casi no se usa si el backend anda)
          const fallback = [
            "5493510000000"
          ];
          return fallback[Math.floor(Math.random() * fallback.length)];
        }
      }

      document.getElementById("whatsappButton").addEventListener("click", async function () {
        // ‚úÖ Traemos n√∫mero din√°mico
        const telefono = await obtenerNumeroWhatsApp();

        const utm = normalizeUtm(getUTMCampaign());
        const codigo = `${LANDING_PREFIX}-${utm}`;

        const variantes = [
          `¬°Hola! Vi este anuncio, ¬øme pas√°s info?`,
          `Hola! Vi el anuncio, ¬øpod√©s darme m√°s info?`,
          `Buenas! ¬øMe cont√°s un poco m√°s del anuncio?`,
          `Hola! Quisiera saber m√°s sobre lo que ofrecen.`,
          `Buenas! ¬øMe das m√°s detalles, por favor?`,
          `Hola! Estoy interesado/a, ¬øc√≥mo funciona todo?`,
          `Hola! Vi tu publicaci√≥n, ¬øpodr√≠as ampliarme la info?`,
          `Buenas! ¬øMe podr√≠as pasar informaci√≥n?`,
          `Hola! Estoy viendo el anuncio, ¬øme das m√°s datos?`,
          `Buenas! Me interesa, ¬øpodr√≠as contarme m√°s?`,
          `Hola! ¬øC√≥mo hago para empezar?`,
          `Buenas! ¬øMe compart√≠s info para sumarme?`,
          `Hola! ¬øTen√©s m√°s detalles del anuncio?`,
          `Buenas! Quiero m√°s info, gracias.`,
          `Hola! Me interesa, ¬øme explic√°s un poco?`,
          `Buenas! ¬øQu√© pasos tengo que seguir?`,
          `Hola! Vi el aviso, ¬øme das info?`,
          `Buenas! Estoy interesado/a, ¬øme pas√°s detalles?`,
          `Hola! ¬øMe cont√°s de qu√© se trata?`,
          `Buenas! Quiero saber m√°s, ¬øme ayud√°s?`,
          `Hola! ¬øPodr√≠as darme un poco m√°s de informaci√≥n?`,
          `Buenas! Estoy viendo el anuncio, ¬øme explic√°s?`,
          `Hola! Estoy interesado/a, ¬øc√≥mo es el proceso?`,
          `Buenas! Me gustar√≠a saber m√°s antes de avanzar.`,
          `Hola! Vi esto, ¬øme pas√°s m√°s data?`,
          `Buenas! ¬øMe podr√≠as orientar un poco?`,
          `Hola! Quiero saber m√°s, ¬øme cont√°s?`,
          `Buenas! Estoy averiguando, ¬øten√©s m√°s info?`,
          `Hola! ¬øC√≥mo hago para continuar?`,
          `Buenas! Estoy interesado/a, ¬øc√≥mo funciona?`,
          `Hola! Vi tu anuncio, ¬øme das m√°s informaci√≥n?`,
          `Buenas! Estoy viendo esto, ¬øme ayud√°s con m√°s detalles?`,
          `Hola! Me interesa, ¬øc√≥mo sigo?`,
          `Buenas! ¬øMe explicar√≠as c√≥mo es todo?`,
          `Hola! ¬øPodr√≠as ampliarme los detalles?`,
          `Buenas! Quisiera saber un poco m√°s.`,
          `Hola! ¬øC√≥mo puedo empezar?`,
          `Buenas! Me llam√≥ la atenci√≥n, ¬øme cont√°s m√°s?`,
          `Hola! ¬øMe pas√°s info para avanzar?`,
          `Buenas! ¬øTen√©s m√°s detalles para compartir?`,
          `Hola! Estoy interesado/a, ¬øc√≥mo ser√≠a todo?`,
          `Buenas! Vi tu publicaci√≥n, ¬øme das m√°s datos?`,
          `Hola! Quiero saber c√≥mo funciona, ¬øme explic√°s?`,
          `Buenas! Vi esto, ¬øc√≥mo puedo seguir?`,
          `Hola! ¬øMe indicar√≠as c√≥mo funciona todo esto?`,
          `Buenas! ¬øMe das info para continuar?`,
          `Hola! Me interesa mucho, ¬øme cont√°s un poco?`,
          `Buenas! Necesito un poco m√°s de info, ¬øpod√©s ayudarme?`,
          `Hola! ¬øQu√© tengo que hacer para empezar?`
        ];

        const mensajeBase = variantes[Math.floor(Math.random() * variantes.length)];
        const mensaje = mensajeBase; // si quer√©s pod√©s agregar el c√≥digo: `${mensajeBase} (${codigo})`
        const link = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;

        // üîµ Evento est√°ndar "Contact" por c√≥digo
        if (window.fbq) {
          fbq('track', 'Contact', {
            content_name: 'CTA WhatsApp',
            content_category: 'LeadGen'
          });
        }

        // Peque√±o delay para asegurar env√≠o antes de abrir WhatsApp
        setTimeout(() => window.open(link, "_blank", "noopener"), 200);
      });
    </script>
  </body>
</html>
