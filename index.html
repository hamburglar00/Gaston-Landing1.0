<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>REYDEASES</title>

  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="./styles.css" />

  <!-- Pixel -->
  <script>
    function getQS(n){return new URLSearchParams(location.search).get(n)}
    function normEmail(v){return (v||"").trim().toLowerCase()}
    function normPhone(v){let p=(v||"").replace(/\D+/g,"");if(p&&p.length===10)p="54"+p;return p;}
    function getOrCreateExternalId(){
      let id=localStorage.getItem("external_id");
      if(!id){id=crypto.randomUUID();localStorage.setItem("external_id",id);}
      return id;
    }

    const userEmail  = normEmail(getQS("em") || localStorage.getItem("em") || "");
    const userPhone  = normPhone(getQS("ph") || localStorage.getItem("ph") || "");
    const externalId = getOrCreateExternalId();

    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){
      n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)
    };
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');

    fbq("init","1148454560830408",{
      external_id: externalId,
      em: userEmail || undefined,
      ph: userPhone || undefined,
      country:"AR"
    });

    fbq("track","PageView");
  </script>

</head>

<body>
  <div class="container background-image">
    <div class="overlay"></div>
    <div class="content">

      <img src="imagenes/logo.png" class="logo" width="240" height="120"
           alt="ReyDeAses" decoding="async" fetchpriority="high" />

      <p class="title">Envianos un WhatsApp<br />para crear tu cuenta</p>

      <a class="whatsapp-button" id="whatsappButton">
        <span>¬°Contact√° ya!</span>
        <img src="imagenes/whatsapp.png" class="whatsapp-icon" width="24" height="24" />
      </a>

      <p class="subtitle">M√≠nimo de carga 2.000<br />Sin Cronogramas<br />Gan√°s y cobr√°s a cualquier hora</p>
      <p class="description">RED OFICIAL: REY DE ASES</p>

    </div>
  </div>

<script>
/* =============================================================
    üìå CONFIG CACHE
============================================================= */
const CACHE_KEY = "wa_numbers_cache_rey";
const CACHE_TTL = 5 * 60 * 1000; // 5 minutos

/* =============================================================
    üìå CARGA N√öMEROS DESDE CACHE O BACKEND
============================================================= */
async function getActiveNumbers() {
  // 1) Cache
  try {
    const cached = JSON.parse(localStorage.getItem(CACHE_KEY));
    if (cached && (Date.now() - cached.ts) < CACHE_TTL && cached.list.length > 0) {
      return cached.list;
    }
  } catch {}

  // 2) Backend
  try {
    const res = await fetch("/api/get-random-phone", {
      headers: { "Cache-Control": "no-store" }
    });

    const data = await res.json();

    let list = [];
    if (Array.isArray(data)) list = data;
    else if (Array.isArray(data.numbers)) list = data.numbers;
    else list = [data];

    // Normalizaci√≥n
    list = list
      .filter(it => it.number)
      .map(it => ({
        number: String(it.number).replace("+","").trim(),
        name: it.name || "Soporte"
      }));

    if (!list.length) throw new Error("vac√≠o");

    // Guardamos cache
    localStorage.setItem(CACHE_KEY, JSON.stringify({
      ts: Date.now(),
      list
    }));

    return list;
  } catch (err) {
    console.error("Fallback por error:", err);

    return [{
      number: "5493512593353",
      name: "Soporte"
    }];
  }
}

/* =============================================================
    üìå VARIANTES (con nombre din√°mico)
============================================================= */
function variantesMensaje(nombre){
  const arr = [
    n => `¬°Hola ${n}! Vi este anuncio, ¬øme pas√°s info?`,
    n => `Hola ${n}! Vi el anuncio, ¬øpod√©s darme m√°s info?`,
    n => `Buenas ${n}! ¬øMe cont√°s un poco m√°s del anuncio?`,
    n => `Hola ${n}! Quisiera saber m√°s sobre lo que ofrecen.`,
    n => `Buenas ${n}! ¬øMe das m√°s detalles, por favor?`,
    n => `Hola ${n}! Estoy interesado/a, ¬øc√≥mo funciona todo?`,
    n => `Holaaa ${n}! Me llam√≥ la atenci√≥n, ¬øme cont√°s m√°s?`,
    n => `Hola ${n}! ¬øC√≥mo hago para empezar?`,
    n => `Buenas ${n}! Me das informaci√≥n para arrancar?`,
    n => `Hola ${n}! Me podr√≠as pasar datos?`
  ];
  return arr[Math.floor(Math.random()*arr.length)](nombre);
}

/* =============================================================
    üìå CLICK WHATSAPP (ultra instant√°neo)
============================================================= */
document.getElementById("whatsappButton").addEventListener("click", async () => {

  const list = await getActiveNumbers();     // ‚Üê instant√°neo si hay cache
  const chosen = list[Math.floor(Math.random()*list.length)];

  const phone  = chosen.number;
  const nombre = chosen.name || "Soporte";

  const mensaje = variantesMensaje(nombre);

  if(window.fbq){
    fbq("track","Contact",{content_name:"CTA WhatsApp"});
  }

  // üöÄ Redirige INSTANT√ÅNEO
  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(mensaje)}`,
              "_blank","noopener");
});
</script>
</body>
</html>
